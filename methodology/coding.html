


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Efficient Coding &mdash; nerfacc 0.5.3 documentation</title>
  

<!--   <link rel="shortcut icon" href="../_static/images/logo192.png" /> -->
  
  

  

  
  
  

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/readthedocs.css" type="text/css" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="next" title="Efficient Sampling" href="sampling.html" />
  <link rel="prev" title="NerfAcc Documentation" href="../index.html" />
  <!-- Google Analytics -->
  <script type="text/javascript">
    var collapsedSections = [];
  </script>
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>
  <script>
    MathJax = {
        chtml: {
            scale: 1,
            minScale: 1,
        },
        svg: {
            scale: 1,
            minScale: 1,
        }
    }
</script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
    integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://www.nerfacc.com/"
        aria-label="LOGO"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://github.com/nerfstudio-project/nerfacc" target="_blank">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

  

  <div class="table-of-contents-link-wrapper">
    <span>Table of Contents</span>
    <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
  </div>

  <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
    <div class="pytorch-side-scroll">
      <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <div class="pytorch-left-menu-search">
          

          
          
          
          

          



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        
        
        
        
        
        <p class="caption" role="heading"><span class="caption-text">Methodology</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Efficient Coding</a></li>
<li class="toctree-l1"><a class="reference internal" href="sampling.html">Efficient Sampling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apis/estimators.html">Estimators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apis/rendering.html">Rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apis/utils.html">Utils</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Usages and Benchmarks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/camera.html">Camera Optimization NeRFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/dynamic.html">Dynamic NeRFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/static.html">Static NeRFs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://docs.nerf.studio/">nerfstudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://autonomousvision.github.io/sdfstudio/">sdfstudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bennyguo/instant-nsr-pl">instant-nsr-pl</a></li>
</ul>

        
        
      </div>
    </div>
  </nav>

  <div class="pytorch-container">
    <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
      <div class="pytorch-breadcrumbs-wrapper">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
            Docs
        </a> &gt;
      </li>

        
      <li>Efficient Coding</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/methodology/coding.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
      </div>

      <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
        Shortcuts
      </div>
    </div>

    <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
      <div class="pytorch-content-left">
        
          <div class="rst-content">
            
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
              <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
                
  <section id="efficient-coding">
<span id="id1"></span><h1>Efficient Coding<a class="headerlink" href="#efficient-coding" title="Permalink to this heading">¶</a></h1>
<section id="monitor-the-gpu-utilization">
<h2>Monitor the GPU Utilization<a class="headerlink" href="#monitor-the-gpu-utilization" title="Permalink to this heading">¶</a></h2>
<p>The rule of thumb is to maximize the computation power you have. When working with GPU,
that means to maximize the percentage of GPU kernels are running at the same time. This
can be monitored by the GPU utilization (last column) reported by the <cite>nvidia-smi</cite> command:</p>
<img alt="../_images/gpu_util.png" class="align-center" src="../_images/gpu_util.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>If the GPU utilization is less than 100%, it means there are some GPU kernels are idling
from time to time (if not all the time). This is of course not good for the performance.
Under the hood, Pytorch will try to use all the GPU kernels to parellelize the computation,
but in most of the case you don’t see 100%. Why is that?</p>
<p>The first reason is simplly that there might not be too much to parellelize, for which
we don’t have too much to do other than increasing batch size. For example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only 1000 threads are running at the same time to create this tensor.</span>
<span class="c1"># So we see 28% GPU utilization.</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1000</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<span class="c1"># Now we see 100% GPU utilization.</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10000000</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The second reason, which is more common, is that there is <em>CPU-GPU synchronization</em>
happening in the code. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">10000000</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="n">ids</span><span class="p">])</span>

<span class="c1"># 100% GPU utilization.</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
<span class="c1"># 95% GPU utilization.</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</pre></div>
</div>
<p>Besides, if there are many cpu operations in the pipeline, such as data loading and
preprocessing, it might also cause the GPU utilization to be low. In this case, you
can try to use <cite>torch.utils.data.DataLoader</cite> to overlap the data processing time
with the GPU computation time.</p>
</section>
<section id="avoid-cpu-gpu-synchronization">
<h2>Avoid CPU-GPU Synchronization<a class="headerlink" href="#avoid-cpu-gpu-synchronization" title="Permalink to this heading">¶</a></h2>
<p>In the above example, if you time your code, you will see a significant difference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 177 µs ± 15.4 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">data</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
<span class="c1"># 355 µs ± 466 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</pre></div>
</div>
<p>Explanation: In this case, the mask operation needs to decide the size of the output tensor, which
lives on CPU, based on the number of <cite>True</cite> values in the mask that lives on GPU. So
a synchronization is required. The index selection operation, on the other hand,
already knows the size of the output tensor based the size of the <cite>ids</cite>, so no
synchronization is required.</p>
<p>You may argue in this case we can’t really improve things because the <cite>ids</cite> are computed
from the <cite>mask</cite>, which would require the synchronization anyway (<cite>torch.where</cite>). However,
in many cases we can avoid the synchronization by carefully writing the code. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># no sync. 67.3 µs ± 5.01 ns per loop</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10000000</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<span class="c1"># sync. 13.7 ms ± 320 µs per loop</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10000000</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Operations that require synchronization including <cite>torch.where</cite>, <cite>tensor.item()</cite>,
<cite>print(tensor)</cite>, <cite>tensor.to(device)</cite>, <cite>torch.nonzero</cite> etc. Just imagine those functions
have a inherit <cite>torch.cuda.synchronize()</cite> called under the hood. See the
<a class="reference external" href="https://pytorch.org/tutorials/recipes/recipes/tuning_guide.html#avoid-unnecessary-cpu-gpu-synchronization">official guide</a>
if with more interests.</p>
<p>In our library, <a class="reference internal" href="../apis/generated/nerfacc.traverse_grids.html#nerfacc.traverse_grids" title="nerfacc.traverse_grids"><code class="xref py py-func docutils literal notranslate"><span class="pre">nerfacc.traverse_grids()</span></code></a> is a function that requires synchronization,
because it needs to know the size of the output tensor when traversing the grids. As a result,
sampling with <a class="reference internal" href="../apis/estimators.html#nerfacc.OccGridEstimator" title="nerfacc.OccGridEstimator"><code class="xref py py-class docutils literal notranslate"><span class="pre">nerfacc.OccGridEstimator</span></code></a> also requires synchronization. But there is
no walkaround in this case so just be aware of it.</p>
</section>
<section id="profiling">
<h2>Profiling<a class="headerlink" href="#profiling" title="Permalink to this heading">¶</a></h2>
<p>There are plenty of tools for profiling. My personal favorite is
<a class="reference external" href="https://github.com/pyutils/line_profiler">line_profiler</a> which will give you <em>per-line</em> runtime
of a function with a simple decorator <cite>&#64;profile</cite>. It is very useful for finding where the bottleneck
is in your code. It is worth to note that due to the asynchronized nature of Pytorch code, you would
need to set <cite>CUDA_LAUNCH_BLOCKING=1</cite> when profiling your code (no matter which profiling tool you are using).
This variable will force CPU-GPU synchronization for every torch function (equavalent to add
<cite>torch.cuda.synchronize()</cite> everywhere), which can reveal the true runtime of each line of code.
And of course, with <cite>CUDA_LAUNCH_BLOCKING=1</cite> you would get slower total runtime, so don’t forget to
remove it when you are done profiling.</p>
</section>
</section>


              </article>
              
            </div>
            <footer>
  
  <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
    
    <a href="sampling.html" class="btn btn-neutral float-right" title="Efficient Sampling" accesskey="n"
      rel="next">Next <img src="../_static/images/chevron-right-blue.svg"
        class="next-page"></a>
    
    
    <a href="../index.html" class="btn btn-neutral" title="NerfAcc Documentation" accesskey="p"
      rel="prev"><img src="../_static/images/chevron-right-blue.svg" class="previous-page"> Previous</a>
    
  </div>
  

  <hr>

  <div role="contentinfo">
    <p>
      &copy; Copyright 2022, Ruilong.

    </p>
  </div>
  
  <div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a
      href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the
      Docs</a>.
  </div>
   

</footer>
          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Efficient Coding</a><ul>
<li><a class="reference internal" href="#monitor-the-gpu-utilization">Monitor the GPU Utilization</a></li>
<li><a class="reference internal" href="#avoid-cpu-gpu-synchronization">Avoid CPU-GPU Synchronization</a></li>
<li><a class="reference internal" href="#profiling">Profiling</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
    </section>
  </div>

  <!-- 
 -->

  

  
  <script type="text/javascript" id="documentation_options" data-url_root="../"
    src="../_static/documentation_options.js"></script>
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
  <script src="../_static/jquery.js"></script>
  <script src="../_static/underscore.js"></script>
  <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
  <script src="../_static/doctools.js"></script>
  <script src="../_static/sphinx_highlight.js"></script>
  

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
  </div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://www.nerfacc.com/" aria-label="LOGO"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://github.com/nerfstudio-project/nerfacc" target="_blank">GitHub</a>
          </li>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function (e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>

</html>